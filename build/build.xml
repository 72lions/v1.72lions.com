<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
This build.xml is used for merging and compressing Javascript and CSS files used for 72lions

Dependencies:
	yuicompressor-2.4.2.jar
	ant-contrib.jar

Basic usage:

	ant main	- updates merged and compressed files for all Javascript and CSS

@author Thodoris Tsiridis
-->
<project name="JS and CSS compressor for 72lions" basedir="." default="main">

	<property name="compressor.dir" value="lib/yuicompressor-2.4.4.jar"/>
	<property name="antcontrib.dir" value="lib/ant-contrib.jar"/>

	<property name="src.js.dir" value="${basedir}/../src/assets/js"/>
	<property name="src.css.dir" value="${basedir}/../src/assets/css"/>
	<property name="dist.js.dir" value="${basedir}/../dist/assets/js"/>
	<property name="dist.css.dir" value="${basedir}/../dist/assets/css"/>

	<property name="src.dir" value="${basedir}/../src"/>
	<property name="dist.dir" value="${basedir}/../dist"/>

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${antcontrib.dir}"/>
		</classpath>
	</taskdef>

	<property name="dist.merged.file.js" value="${dist.js.dir}/72lions.merged.js"/>
	<property name="dist.compressed.file.js" value="${dist.js.dir}/72lions.merged.min.js" />

	<property name="dist.merged.file.css" value="${dist.css.dir}/72lions.merged.css"/>
	<property name="dist.compressed.file.css" value="${dist.css.dir}/72lions.merged.min.css" />

	<!-- Merges all javascript files into one. Remember, order matters! -->
	<target name="merge-global-js">
		<concat destfile="${dist.merged.file.js}" fixlastline="yes" append="no">
			<!-- include 72lions global -->
			<filelist><file name="${src.js.dir}/libs/jquery.easing.1.3.js"/></filelist>
			<!-- include 72lions component loader -->
			<filelist><file name="${src.js.dir}/router.js"/></filelist>
			<!-- include Flash Object -->
			<filelist><file name="${src.js.dir}/eventtarget.js"/></filelist>
			<!-- include UI Animations Object -->
			<filelist><file name="${src.js.dir}/namespaces.js"/></filelist>
			<filelist><file name="${src.js.dir}/lookup.js"/></filelist>
			<filelist><file name="${src.js.dir}/console.js"/></filelist>
			<filelist><file name="${src.js.dir}/controllers/*"/></filelist>
			<!-- include Helpers -->
			<fileset dir="${src.js.dir}" includes="models/*"/>
			<!-- include jQuery Plugins -->
			<fileset dir="${src.js.dir}" includes="views/*"/>
			<!-- include the 72lions bootstrap last -->
			<filelist><file name="${src.js.dir}/bootstrap.js"/></filelist>
		</concat>
	</target>


	<!-- Comment out console.log commands from merged script -->
	<target name="clean-merged-js" depends="merge-global-js" description="Comment out console.log lines">
		<echo>Commenting out console.log lines</echo>
		<replaceregexp file="${dist.merged.file.js}" match="(console.log\(.*\))" replace="/\*\1\*/" flags="g" />
	</target>


	<!-- Compress the merged common javascript file -->
	<target name="compress-global-js" depends="clean-merged-js">
		<echo>${dist.merged.file.js} to ${dist.compressed.file.js}</echo>
		<java jar="${compressor.dir}" fork="true">
			<arg value="${dist.merged.file.js}"/>
			 <arg line="--line-break"/>
		  <arg line="4000"/>
			<arg value="-o"/>
			<arg value="${dist.compressed.file.js}"/>
		</java>
    </target>



	<!-- Concat all css files. Add all files you wish to merge. Remember order matters! -->
	<target name="merge-global-css">
		<concat destfile="${dist.merged.file.css}" fixlastline="yes" append="no">
			<filelist dir="${src.css.dir}" files="
				reset.css
				ui.css
				layout.css
				navigation.css
				portfolio.css
				about.css
				blog.css
				postdetails.css
				"/>

		</concat>
	</target>

	<!-- Compress a merged css file. This step should occur after merge -->
	<target name="compress-global-css" depends="merge-global-css">
		<java jar="${compressor.dir}" fork="true">
			<arg value="${dist.merged.file.css}"/>
			<arg value="-o"/>
			<arg value="${dist.compressed.file.css}"/>
		</java>
    </target>

	<!-- Copy IE specific files to dist folder -->
	<target name="copy-selected-files">
		<copy todir="${dist.dir}" flatten="true">
			<fileset dir="${src.dir}" includes="*" excludes="assets"/>
		</copy>
		<copy todir="${dist.css.dir}" overwrite="yes">
			<filelist dir="${src.css.dir}" files="
			mobile-hires.css
			"/>
		</copy>
		<copy todir="${dist.dir}/api">
			<fileset dir="${src.dir}/api" includes="**/*" />
		</copy>
		<copy todir="${dist.js.dir}/libs">
			<fileset dir="${src.js.dir}/libs" includes="**/*" />
		</copy>
	</target>

	<target name="clean-js">
		<delete>
			<fileset dir="${dist.js.dir}" includes="**/*"/>
		</delete>
	</target>

	<target name="clean-css">
		<delete>
			<fileset dir="${dist.css.dir}" includes="**/*"/>
		</delete>
	</target>

	<target name="clean-src">
		<delete>
			<fileset dir="${dist.dir}" includes="*"/>
		</delete>
		<delete dir="${dist.dir}/api"></delete>
	</target>

    <!-- Replace the source files with the minified and concatenated -->
    <target name="update-source-with-new-compiled-files">
		<replaceregexp match="\&lt;!--source scripts--\&gt;(.*?)\&lt;!--end source scripts--\&gt;" replace="\&lt;script src='/assets/js/72lions.merged.min.js'\&gt;\&lt;/script\&gt;" flags="gs" encoding="utf8">
		        <fileset dir="${dist.dir}" includes="index.php"/>
		</replaceregexp>
		<replaceregexp match="\&lt;!--source css--\&gt;(.*?)\&lt;!--end source css--\&gt;" replace="\&lt;link rel='stylesheet' href='/assets/css/72lions.merged.min.css' /\&gt;" flags="gs"  encoding="utf8">
		        <fileset dir="${dist.dir}" includes="index.php"/>
		</replaceregexp>
    </target>

	<!-- run all tasks -->
	<target name="main" depends="clean-src, clean-js, compress-global-js,  clean-css, compress-global-css, copy-selected-files, update-source-with-new-compiled-files">
    </target>

</project>
